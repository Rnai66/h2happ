import express from "express";
import OpenAI from "openai";
import crypto from "crypto";
import { LRUCache } from "lru-cache";

console.log("üî• ai.js ROUTE FILE LOADED");

const router = express.Router();

const aiCache = new LRUCache({
  max: Number(process.env.AI_CACHE_MAX || 500),
  ttl: Number(process.env.AI_CACHE_TTL_MS || 1000 * 60 * 60),
  allowStale: false,
  updateAgeOnGet: true,
});

// üîÅ ‡πÉ‡∏ä‡πâ map ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ coalescing ‚Üí ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏¢‡∏¥‡∏á key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡∏à‡∏∞‡∏£‡∏≠ promise ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
const pendingPromises = new Map();

// ====== Helper functions ======
function normStr(v) {
  if (v === undefined || v === null) return "";
  return String(v).trim().toLowerCase();
}

function normNum(v) {
  if (v === undefined || v === null || v === "") return 0;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function makeCacheKey({ query, stats }) {
  const stable = {
    v: 1,
    query: normStr(query),
    stats: {
      count: normNum(stats?.count),
      avgPrice: normNum(stats?.avgPrice),
      medianPrice: normNum(stats?.medianPrice),
      minPrice: normNum(stats?.minPrice),
      maxPrice: normNum(stats?.maxPrice),
    },
  };
  const raw = JSON.stringify(stable);
  return crypto.createHash("sha256").update(raw).digest("hex");
}

// ====== Main Route ======
router.post("/price-advice", async (req, res) => {
  try {
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return res.status(500).json({ ok: false, message: "OPENAI_API_KEY missing" });
    }

    const { query, stats, sampleItems } = req.body || {};
    if (!query) {
      return res.status(400).json({ ok: false, message: "Missing query" });
    }

    const cacheKey = makeCacheKey({ query, stats });

    // === Cache HIT ===
    const cachedAdvice = aiCache.get(cacheKey);
    if (cachedAdvice) {
      res.setHeader("X-Cache", "HIT");
      return res.json({ ok: true, advice: cachedAdvice, cached: true });
    }

    res.setHeader("X-Cache", "MISS");

    // === Coalescing ===
    if (pendingPromises.has(cacheKey)) {
      const shared = await pendingPromises.get(cacheKey);
      return res.json({ ok: true, advice: shared, cached: false, shared: true });
    }

    // === NEW Request ===
    const promise = (async () => {
      const client = new OpenAI({ apiKey });

      const system = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ß‡πà‡∏≤ ‚Äú‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‚Äù
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏¢

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á:
- summary: ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ 1‚Äì2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
- suggestedPrice: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
- bullets: ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ 3‚Äì6 ‡∏Ç‡πâ‡∏≠ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
- risks: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô 1‚Äì2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)

‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ
- ‡∏°‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‚Äù
- ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á
- ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô risks ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å JSON
      `.trim();

      const payload = {
        query,
        stats: {
          count: normNum(stats?.count),
          avgPrice: normNum(stats?.avgPrice),
          medianPrice: normNum(stats?.medianPrice),
          minPrice: normNum(stats?.minPrice),
          maxPrice: normNum(stats?.maxPrice),
        },
        sampleItems: Array.isArray(sampleItems)
          ? sampleItems.slice(0, 6)
          : [],
      };

      const resp = await client.chat.completions.create({
        model: process.env.AI_MODEL || "gpt-4o-mini",
        temperature: 0.2,
        messages: [
          { role: "system", content: system },
          { role: "user", content: JSON.stringify(payload) },
        ],
      });

      const text = resp.choices?.[0]?.message?.content || "{}";

      let advice;
      try {
        advice = JSON.parse(text);
      } catch {
        advice = {
          summary: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥",
          suggestedPrice: normNum(stats?.medianPrice) || normNum(stats?.avgPrice) || 0,
          bullets: [
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏à‡∏≥‡∏Å‡∏±‡∏î",
            "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏≤‡∏à‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
          ],
          risks: "‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢",
        };
      }

      // === Save to cache ===
      aiCache.set(cacheKey, advice);
      return advice;
    })();

    // ‡πÄ‡∏Å‡πá‡∏ö pending ‡πÑ‡∏ß‡πâ
    pendingPromises.set(cacheKey, promise);

    let result;
    try {
      result = await promise;
    } finally {
      pendingPromises.delete(cacheKey); // ‡∏•‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    }

    return res.json({ ok: true, advice: result, cached: false });
  } catch (err) {
    console.error("‚ùå ai/price-advice error:", err);
    return res.status(500).json({ ok: false, message: "AI server error" });
  }
});

export default router;
